name: Release

on:
    workflow_call:
      
jobs:
    publish-to-pypi:
      name: >-
        Publish Python ğŸ distribution ğŸ“¦ to PyPI
      if: startsWith(github.ref, 'refs/tags/')  # only publish to PyPI on tag pushes
      runs-on: ubuntu-latest
      environment:
        name: pypi
        url: https://pypi.org/p/sunbeamlib
      permissions:
        id-token: write  # IMPORTANT: mandatory for trusted publishing

      steps:
        - name: Download all the dists
          uses: actions/download-artifact@v4
          with:
            name: python-package-distributions
            path: dist/
        - name: Publish distribution ğŸ“¦ to PyPI
          uses: pypa/gh-action-pypi-publish@release/v1

    publish-to-dockerhub:
      name: >-
        Publish Docker ğŸ³ image ğŸ“¦ to Docker Hub
      if: startsWith(github.ref, 'refs/tags/')  # only publish to Docker Hub on tag pushes
      runs-on: ubuntu-latest

      steps:
        - uses: actions/checkout@v4

        - name: Log in to Docker Hub
          uses: docker/login-action@v3
          with:
            username: ${{ secrets.DOCKERHUB_USERNAME }}
            password: ${{ secrets.DOCKERHUB_TOKEN }}

        - name: Extract Docker metadata
          id: meta
          uses: docker/metadata-action@v5
          with:
            images: sunbeamlabs/sunbeam

        - name: Build and push full image
          uses: docker/build-push-action@v5
          with:
            context: .
            file: ./Dockerfile
            push: true
            tags: |
              sunbeamlabs/sunbeam:latest
              sunbeamlabs/sunbeam:${{ github.ref_name }}
            labels: ${{ steps.meta.outputs.labels }}

        - name: Build and push slim image
          uses: docker/build-push-action@v5
          with:
            context: .
            file: ./slim.Dockerfile
            push: true
            tags: sunbeamlabs/sunbeam:${{ github.ref_name }}-slim
            labels: ${{ steps.meta.outputs.labels }}
